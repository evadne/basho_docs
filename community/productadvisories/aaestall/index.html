<!DOCTYPE html>



<html class="no-js" lang="en">




<head>

  <meta charset="utf-8">
  <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
  <meta name="viewport" content="width=device-width">
  <link rel="shortcut icon" href="//evadne.github.io/basho_docs/images/branding/favicon.ico" type="image/x-icon" />

  <title>Active Anti-Entropy: Slight chance that AAE could stall itself or crash a Riak node.</title>

  <link href="//evadne.github.io/basho_docs/css/main.css" media="screen" rel="stylesheet" type="text/css">
  <link rel="canonical" href="//evadne.github.io/basho_docs/community/productadvisories/aaestall/" />
  <!-- The below meta tags are included to allow JS code to use variables
       defined in Hugo---our static site generator. -->
  <meta name="project" content="community">
  <meta name="project_relative_path" content="productadvisories/aaestall/">

</head>



<body class="community">


  <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-T9C8MK" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-T9C8MK');</script>


  
<header class="banner">



  
  <div class="float-right   banner__menu-bars   [bs] hidden-md-up">
    <div class="menu-bars   js_toggle-content-nav"></div>
  </div>



  
  <div class="float-left   banner__docs-logo">
    <a href="//evadne.github.io/basho_docs/index.html" class="block   docs-logo"><img class="docs-logo__image" src="//evadne.github.io/basho_docs/images/branding/basho_docs_logo.png"></a>
  </div>



  
  <div class="overflow-hidden   banner__navigation-pane   [bs] hidden-sm-down">


    
    <div class="float-left    banner__intra-brand__width-wrapper">
    <div class="float-right   banner__intra-brand">
      <div class="float-right">
        
        <a class="inline-block   banner__brand-link" href="http://basho.com/">Basho</a><a class="inline-block   banner__brand-link" href="https://academy.basho.com">Academy</a><a class="inline-block   banner__brand-link" href="//evadne.github.io/basho_docs/community">Community</a><a class="inline-block   banner__brand-link" href="http://basho.com/contact">Contact</a></div>
    </div>
    </div>




    
    <div class="float-left    banner__intra-site__width-wrapper">
    <div class="float-right   banner__intra-site">
      
      <a class="inline-block   banner__brand-link " href="//evadne.github.io/basho_docs/riak/kv/latest/">Riak KV</a><a class="inline-block   banner__brand-link " href="//evadne.github.io/basho_docs/riak/ts/latest/">Riak TS</a><a class="inline-block   banner__brand-link " href="//evadne.github.io/basho_docs/riak/cs/latest/">Riak CS</a></div>
    </div>


  </div>

</header>



  
  



<nav class="content-nav content-nav--top-size-half">




  <div class="content-nav__fixed-top">
    <form id="searchbox_011972015458788978446:zgdcy4fa-o0" class="search" action="">

      <span class="block float-left   search__icon-container   docs-icon--search">|</span>

      <span class="block overflow">
        <input class="search__input" id="main-search" type="search" name="q" placeholder="Search">
      </span>

    </form>



  </div>





  
  <div class="             content-nav__primary__sizing-box">
  <div class="             content-nav__primary__shadow-box">
  <div class="overflow-y   content-nav__primary">

    <div class="content-nav__menu-container">

      <ul class="content-menu
                 content-menu--depth-0
                 content-menu--open">


        <li >

          <div class="content-menu__item ">

            <span class="block float-left   content-menu__icon-container   docs-icon--comments">|</span>
            <span class="block float-right   content-menu__menu-toggle
                         content-menu__menu-toggle--open ">
            </span>

            <a class="block overflow   content-menu__link--depth-0"  href="//evadne.github.io/basho_docs/community/" >
              <span class="block   content-menu__item__right-border"><strong>Community</strong></span>
            </a>

          </div>
          
          


<ul class="content-menu
           content-menu--depth-1
           content-menu--open"
    style="display: block">



  <li>

    <div class="content-menu__item ">
      <span class="block float-right   content-menu__menu-toggle
                   content-menu__menu-toggle--open ">
      </span>

      <a class="block overflow   content-menu__link--depth-1"  href="//evadne.github.io/basho_docs/community/productadvisories/" >
        <span class="block   content-menu__item__right-border">Product Advisories</span>
      </a>

    </div>
    
    


<ul class="content-menu
           content-menu--depth-2
           content-menu--open"
    style="display: block">



  <li>

    <div class="content-menu__item  content-menu__item--selected ">

      <a class="block overflow   content-menu__link--depth-2" >
        <span class="block   content-menu__item__right-border">AAE: Slight Chance for Stall or Crash</span>
      </a>

    </div>

  </li>



  <li>

    <div class="content-menu__item ">

      <a class="block overflow   content-menu__link--depth-2"  href="//evadne.github.io/basho_docs/community/productadvisories/130-dataloss/" >
        <span class="block   content-menu__item__right-border">Data Loss TS 1.3.0</span>
      </a>

    </div>

  </li>



  <li>

    <div class="content-menu__item ">

      <a class="block overflow   content-menu__link--depth-2"  href="//evadne.github.io/basho_docs/community/productadvisories/leveldbsegfault/" >
        <span class="block   content-menu__item__right-border">LeveDB Segfault</span>
      </a>

    </div>

  </li>



  <li>

    <div class="content-menu__item ">

      <a class="block overflow   content-menu__link--depth-2"  href="//evadne.github.io/basho_docs/community/productadvisories/codeinjectioninitfiles/" >
        <span class="block   content-menu__item__right-border">Possibility of Code Injection on Riak Init File</span>
      </a>

    </div>

  </li>



  <li>

    <div class="content-menu__item ">

      <a class="block overflow   content-menu__link--depth-2"  href="//evadne.github.io/basho_docs/community/productadvisories/golang151socket/" >
        <span class="block   content-menu__item__right-border">Socket Reuse in Riak Golang 1.5.1</span>
      </a>

    </div>

  </li>



  <li>

    <div class="content-menu__item ">

      <a class="block overflow   content-menu__link--depth-2"  href="//evadne.github.io/basho_docs/community/productadvisories/leveldbrestart/" >
        <span class="block   content-menu__item__right-border">Potential Data Loss with LevelDB Tiered Storage</span>
      </a>

    </div>

  </li>



  <li>

    <div class="content-menu__item ">

      <a class="block overflow   content-menu__link--depth-2"  href="//evadne.github.io/basho_docs/community/productadvisories/dvvlastwritewins/" >
        <span class="block   content-menu__item__right-border">Incompatiblility with DVV and Last-Write Wins</span>
      </a>

    </div>

  </li>



  <li>

    <div class="content-menu__item ">

      <a class="block overflow   content-menu__link--depth-2"  href="//evadne.github.io/basho_docs/community/productadvisories/210-dataloss/" >
        <span class="block   content-menu__item__right-border">Data Loss KV 2.1.0</span>
      </a>

    </div>

  </li>



  <li>

    <div class="content-menu__item ">

      <a class="block overflow   content-menu__link--depth-2"  href="//evadne.github.io/basho_docs/community/productadvisories/sslpoodle/" >
        <span class="block   content-menu__item__right-border">SSL 3.0 Vulnerability and POODLE Attack</span>
      </a>

    </div>

  </li>



  <li>

    <div class="content-menu__item ">

      <a class="block overflow   content-menu__link--depth-2"  href="//evadne.github.io/basho_docs/community/productadvisories/maps-204/" >
        <span class="block   content-menu__item__right-border">Map Data Type Disk Incompatibility</span>
      </a>

    </div>

  </li>



</ul>

  </li>



  <li>

    <div class="content-menu__item ">

      <a class="block overflow   content-menu__link--depth-1"  href="//evadne.github.io/basho_docs/community/taishi/" >
        <span class="block   content-menu__item__right-border">Taishi Program</span>
      </a>

    </div>

  </li>



  <li>

    <div class="content-menu__item ">

      <a class="block overflow   content-menu__link--depth-1"  href="//evadne.github.io/basho_docs/community/projects/" >
        <span class="block   content-menu__item__right-border">Community Projects</span>
      </a>

    </div>

  </li>



  <li>

    <div class="content-menu__item ">

      <a class="block overflow   content-menu__link--depth-1"  href="//evadne.github.io/basho_docs/community/reporting-bugs/" >
        <span class="block   content-menu__item__right-border">Reporting Bugs</span>
      </a>

    </div>

  </li>



  <li>

    <div class="content-menu__item ">

      <a class="block overflow   content-menu__link--depth-1"  href="//evadne.github.io/basho_docs/community/release-and-maintenance/" >
        <span class="block   content-menu__item__right-border">Release &amp; Maintenance</span>
      </a>

    </div>

  </li>



</ul>

        </li>

        <li class="content-menu__blank-entry"></li>

      </ul>

    </div>



    <div class="content-nav__fixed-bottom">

      <ul class="content-menu">

        <li>
          <div class="content-menu__item">

            <span class="block float-left   content-menu__icon-container   docs-icon--comments">|</span>

            <a class="block overflow" href="//evadne.github.io/basho_docs/community">
              <span class="block   content-menu__item__right-border">
                <sub>Want some extra help?</sub><br>
                <strong>Ask our Community</strong>
              </span>
            </a>

          </div>
        </li>

        <li>
          <div class="content-menu__item">

            <span class="block float-left   content-menu__icon-container   docs-icon--question-sign">|</span>

            <a class="block overflow" href="http://basho.com/contact">
              <span class="block   content-menu__item__right-border">
                <sub>Need to chat?</sub><br>
                <strong>Contact us directly</strong>
              </span>
            </a>

          </div>
        </li>

        <li>
          <div class="content-menu__item">

            <span class="block float-left   content-menu__icon-container   docs-icon--github-alt">|</span>

            <a class="block overflow" href="https://github.com/basho/basho_docs/edit/master/content/community/productadvisories/aaestall.md">
              <span class="block   content-menu__item__right-border">
                <sub>Noticed a typo?</sub><br>
                <strong>Correct it in GitHub</strong>
              </span>
            </a>

          </div>
        </li>

      </ul>

    </div>

  </div>
  </div>
  </div>



</nav>

<script>
  (function() {
    var cx = '011972015458788978446:zgdcy4fa-o0';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
        '//cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<div style="width:0px;overflow:hidden;height:0px;">
  <gcse:search></gcse:search>
</div>






  <div class="content-well">


    <article class="main-article">


      

<header class="front-matter">


  <h1 class="front-matter__title">

    
    <br>
    Active Anti-Entropy: Slight chance that AAE could stall itself or crash a Riak node.

  </h1>
  <nav class="table-of-contents"></nav>


</header>


      <main>
        

<table>
<thead>
<tr>
<th align="left">Info</th>
<th align="left">Value</th>
</tr>
</thead>

<tbody>
<tr>
<td align="left">Date issued</td>
<td align="left">November 17, 2016</td>
</tr>

<tr>
<td align="left">Product</td>
<td align="left">Riak KV</td>
</tr>

<tr>
<td align="left">Affected versions</td>
<td align="left">Riak KV 2.0.0+, Riak KV 2.1.0+</td>
</tr>
</tbody>
</table>

<h2 id="overview">Overview</h2>

<p>There exists a highly unlikely condition where Riak KV’s active anti-entropy feature can either stall or cause a segmentation fault crash.</p>

<div class="blocknote">
  
    <div class="blocknote__title">Riak KV Enterprise Edition</div>
  
  <p>If you are using Riak KV Enterprise Edition, please see the Product Advisory in the Basho Support Portal for your patches and instructions.</p>

</div>


<h2 id="description">Description</h2>

<p>The active anti-entropy feature (AAE) has a procedure known as a hash tree rebuild.  This procedure uses a LevelDB feature called an iterator.  The rebuild procedure has the potential to simultaneously instruct the iterator to retrieve the next data item and to close the iterator.  The probability of both happening is very slight, but Basho was able to create the simultaneous instructions under extremely heavy loads across many hours.</p>

<p>AAE stores its metadata within a LevelDB database.  This metadata is independent of the user’s selected storage backend for Riak (LevelDB, Bitcask, memory, or multi).  Therefore all users of AAE are impacted regardless of their chosen storage backend.</p>

<h2 id="affected-users">Affected Users</h2>

<p>You could be impacted if you are running one of the listed versions of Riak KV and your riak.conf has the default setting: <code>entropy = active</code>.</p>

<ul>
<li>Riak KV 2.0.0+</li>
<li>Riak KV 2.1.0+</li>
</ul>

<h2 id="impact">Impact</h2>

<p>Active entropy hash tree rebuilds could stall indefinitely on a Riak node, or
A Riak node could experience a segmentation fault that requires restarting Riak.</p>

<h2 id="mitigation-strategy">Mitigation Strategy</h2>

<p>There are two approaches you can take to mitigate this issue:</p>

<ul>
<li>Update to the newly released Riak KV 2.2, or</li>
<li>Patch eLevelDB to 2.0.32.</li>
</ul>

<h2 id="patching-eleveldb-to-2-0-32">Patching eLevelDB to 2.0.32</h2>

<p>If an upgrade to Riak KV 2.2 is not possible in your environment, the LevelDB library can be patched. This patch contains natively-compiled code and is operating system specific.</p>

<div class="blocknote">
  
    <div class="blocknote__title">WARNING</div>
  
  <p>Do not apply the eleveldb.so patch to Riak TS, it will prevent it functioning correctly.</p>

</div>


<h4 id="os-specific-package-links">OS specific package links:</h4>

<ul>
<li><a href="https://s3.amazonaws.com/downloads.basho.com/patches/eleveldb/2.0.32/eleveldb_2.0.32_debian6.tar.gz">Debian 6</a></li>
<li><a href="https://s3.amazonaws.com/downloads.basho.com/patches/eleveldb/2.0.32/eleveldb_2.0.32_debian7.tar.gz">Debian 7</a></li>
<li><a href="https://s3.amazonaws.com/downloads.basho.com/patches/eleveldb/2.0.32/eleveldb_2.0.32_fedora19.tar.gz">Fedora 19</a></li>
<li><a href="https://s3.amazonaws.com/downloads.basho.com/patches/eleveldb/2.0.32/eleveldb_2.0.32_freebsd10.tar.gz">FreeBSD 9</a></li>
<li><a href="https://s3.amazonaws.com/downloads.basho.com/patches/eleveldb/2.0.32/eleveldb_2.0.32_osx10.8.tar.gz">OS X 10</a></li>
<li><a href="https://s3.amazonaws.com/downloads.basho.com/patches/eleveldb/2.0.32/eleveldb_2.0.32_rhel5.tar.gz">RHEL 5</a></li>
<li><a href="https://s3.amazonaws.com/downloads.basho.com/patches/eleveldb/2.0.32/eleveldb_2.0.32_rhel6.tar.gz">RHEL 6</a></li>
<li><a href="https://s3.amazonaws.com/downloads.basho.com/patches/eleveldb/2.0.32/eleveldb_2.0.32_rhel7.tar.gz">RHEL 7</a></li>
<li><a href="https://s3.amazonaws.com/downloads.basho.com/patches/eleveldb/2.0.32/eleveldb_2.0.32_sles11.tar.gz">SLES 11</a></li>
<li><a href="https://s3.amazonaws.com/downloads.basho.com/patches/eleveldb/2.0.32/eleveldb_2.0.32_smartos1.8.tar.gz">SmartOS 1.8</a></li>
<li><a href="https://s3.amazonaws.com/downloads.basho.com/patches/eleveldb/2.0.32/eleveldb_2.0.32_smartos13.1.tar.gz">SmartOS 13.1</a></li>
<li><a href="https://s3.amazonaws.com/downloads.basho.com/patches/eleveldb/2.0.32/eleveldb_2.0.32_solaris10.tar.gz">Solaris 10</a></li>
<li><a href="https://s3.amazonaws.com/downloads.basho.com/patches/eleveldb/2.0.32/eleveldb_2.0.32_ubuntuLucid.tar.gz">Ubuntu Lucid</a></li>
<li><a href="https://s3.amazonaws.com/downloads.basho.com/patches/eleveldb/2.0.32/eleveldb_2.0.32_ubuntuPrecise.tar.gz">Ubuntu Precise</a></li>
<li><a href="https://s3.amazonaws.com/downloads.basho.com/patches/eleveldb/2.0.32/eleveldb_2.0.32_ubuntuTrusty.tar.gz">Ubuntu Trusty</a></li>
</ul>

<h3 id="install-the-patch">Install the Patch</h3>

<p>To install this patch, on each node in the cluster you must:</p>

<ol>
<li><p>Determine your eleveldb directory<a name="determining"></a>.</p>

<ol>
<li>Find the Riak <code>lib</code> directory

<ul>
<li>RHEL/Centos/Fedora/SLES: <code>/usr/lib64/riak/lib/</code></li>
<li>Ubuntu/Debian: <code>/usr/lib/riak/lib/</code></li>
<li>FreeBSD: <code>/usr/local/lib/riak/lib/</code></li>
<li>SmartOS: <code>/opt/local/lib/riak/lib/</code></li>
<li>Solaris: <code>/opt/riak/lib/</code></li>
</ul></li>
<li>Consult the directory listing for a directory beginning with <code>eleveldb</code>, for example: <code>eleveldb-2.0.17-0-g973fc92</code> on Riak KV 2.1.4 or <code>eleveldb-2.0.22-0-g185e296</code> on Riak KV 2.0.7</li>
<li>Make a note of this directory name for the following steps.</li>
</ol></li>

<li><p>Stop the node by running <code>riak stop</code>.</p></li>

<li><p>Change to the priv subdirectory of <a href="#determining">your eleveldb directory</a>.</p></li>

<li><p>Rename the original eleveldb.so file to eleveldb.so.orig.</p></li>

<li><p>Copy the provided eleveldb.so to the directory and verify correct permissions.</p></li>

<li><p>If possible, verify that the md5sum of the eleveldb.so located in the eleveldb priv directory is correct.</p></li>

<li><p>Change into the ebin subdirectory of <a href="#determining">your eleveldb directory</a>.</p></li>

<li><p>Rename the original eleveldb.beam file to eleveldb.beam.orig.</p></li>

<li><p>Copy the provided eleveldb.beam to the directory and verify correct permissions.</p></li>

<li><p>If possible, verify that the md5sum of the eleveldb.beam located in the eleveldb ebin directory is correct.</p></li>

<li><p>Start the node by running <code>riak start</code>.</p></li>
</ol>

<h3 id="to-back-out-of-this-patch-on-each-node-in-the-cluster-you-must">To back out of this patch, on each node in the cluster you must:</h3>

<ol>
<li><p>Determine your eleveldb directory<a name="determining2"></a>.</p>

<ol>
<li>Change to the Riak lib directory

<ul>
<li>RHEL/Centos/Fedora/SLES: <code>/usr/lib64/riak/lib/</code></li>
<li>Ubuntu/Debian: <code>/usr/lib/riak/lib/</code></li>
<li>FreeBSD: <code>/usr/local/lib/riak/lib/</code></li>
<li>SmartOS: <code>/opt/local/lib/riak/lib/</code></li>
<li>Solaris: <code>/opt/riak/lib/</code></li>
</ul></li>
<li>Consult the directory listing for a directory beginning with <code>eleveldb</code>, for example: <code>eleveldb-2.0.17-0-g973fc92</code> on Riak KV 2.1.4 or <code>eleveldb-2.0.22-0-g185e296</code> on Riak KV 2.0.7</li>
<li>Make a note of this directory name for the following steps.</li>
</ol></li>

<li><p>Stop the node by running <code>riak stop</code>.</p></li>

<li><p>Change to the priv subdirectory of <a href="#determining">your eleveldb directory</a>.</p></li>

<li><p>Verify that you have an eleveldb.so.orig file present in this directory.</p></li>

<li><p>Remove the patched eleveldb.so file.</p></li>

<li><p>Rename <code>eleveldb.so.orig</code> to <code>eleveldb.so</code>.</p></li>

<li><p>Change into the ebin subdirectory of <a href="#determining">your eleveldb directory</a>.</p></li>

<li><p>Verify that you have an eleveldb.beam.orig file present in this directory.</p></li>

<li><p>Remove the patched <code>eleveldb.beam</code> file.</p></li>

<li><p>Rename <code>eleveldb.beam.orig</code> to <code>eleveldb.beam</code>.</p></li>

<li><p>Start the node by running <code>riak start</code>.</p></li>
</ol>

<h2 id="verifying-the-patch-installation">Verifying the Patch Installation</h2>

<p>When the patch is installed, the LevelDB LOG files will report that version 2.0.31 is installed.</p>

<div class="blocknote">
  
  <p><strong>Note</strong>:  this is eleveldb version 2.0.32 but the leveldb LOG file is expected to report 2.0.31.</p>

</div>


<p>The LOG files for each running vnode will have a log line similar to the following:</p>

<pre><code>2016/03/17-18:42:50.544293 7ffaaf3b1700             Version: 2.0.31
</code></pre>

      </main>


    </article>


    <footer class="footer">

  <div class="inline-block   footer__attributions">

    <p>
      This work is licensed under a
      <br class="[bs] hidden-md-up">
      <a href="http://creativecommons.org/licenses/by/4.0/" target="_blank">
        Creative Commons Attribution 4.0 <br class="[bs] hidden-sm-up"> International Public License
      </a>
    </p>

    <p>
      © 2011-2017&nbsp;<a href="http://www.basho.com">Basho Technologies, Inc.</a>
    </p>

  </div>

</footer>



  </div>


  <script src="//evadne.github.io/basho_docs/js/main.js" type="text/javascript"></script>

</body>
</html>
